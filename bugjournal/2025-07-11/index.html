<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Bug Journal 2025-07-11 | TzJ&#39;s Net</title>
<meta name="keywords" content="Bug Journal, LoRA">
<meta name="description" content="LoRA tutorial">
<meta name="author" content="">
<link rel="canonical" href="https://tzj2006.github.io/bugjournal/2025-07-11/">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="https://tzj2006.github.io/assets/css/stylesheet.af858c2feef42adc7846f815c3e21de9982d82f8fc4f65879451b2686859975a.css" integrity="sha256-r4WML&#43;70Ktx4RvgVw&#43;Id6Zgtgvj8T2WHlFGyaGhZl1o=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://tzj2006.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://tzj2006.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://tzj2006.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://tzj2006.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://tzj2006.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://tzj2006.github.io/bugjournal/2025-07-11/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script type="text/javascript" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


<script src="https://tzj2006.github.io/js/checkbox-state.min.481208bf28be32dd7419d90065130144ba9a464a94857de0dc07fd19d3f2f6f3.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>
<meta property="og:url" content="https://tzj2006.github.io/bugjournal/2025-07-11/">
  <meta property="og:site_name" content="TzJ&#39;s Net">
  <meta property="og:title" content="Bug Journal 2025-07-11">
  <meta property="og:description" content="LoRA tutorial">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="bugjournal">
    <meta property="article:published_time" content="2025-07-11T11:33:41+08:00">
    <meta property="article:modified_time" content="2025-07-11T11:33:41+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bug Journal 2025-07-11">
<meta name="twitter:description" content="LoRA tutorial">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "BugJournals",
      "item": "https://tzj2006.github.io/bugjournal/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Bug Journal 2025-07-11",
      "item": "https://tzj2006.github.io/bugjournal/2025-07-11/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bug Journal 2025-07-11",
  "name": "Bug Journal 2025-07-11",
  "description": "LoRA tutorial",
  "keywords": [
    "Bug Journal", "LoRA"
  ],
  "articleBody": "LoRA finetuning ä¹‹å‰ä¸€ç›´å¬è¯´ LoRA çš„å¤§åï¼Œä»Šå¤©æ¥çœ‹çœ‹ LoRA åˆ°åº•åœ¨åšä»€ä¹ˆ\næ­£å¥½æˆ‘çœ‹åˆ°äº† huggingface ä¸Šæœ‰ LoRA tutorial æ‰€ä»¥å°±è¿‡æ¥ç ”ç©¶äº†ä¸€ä¸‹ğŸ§\næ³¨ï¼šä»£ç é¡ºåºä¸ tutorialä¸­ç•¥æœ‰å‡ºå…¥\nçœæµï¼šæƒ³çœ‹ LoRA specific çš„åŒå­¦è¯·ç›´æ¥ä»[è¿™é‡Œå¼€å§‹çœ‹](#Step 5: è®­ç»ƒå‰å‡†å¤‡)\nStep1: å¯¼å…¥éœ€è¦ç”¨åˆ°çš„ package import transformers import accelerate import torch import peft print(f\"transformers version: {transformers.__version__}\") print(f\"accelerate version: {accelerate.__version__}\") print(f\"torch version: {torch.__version__}\") print(f\"peft version: {peft.__version__}\") éœ€è¦å¯¼å…¥çš„ package å¤§æ¦‚å°±è¿™ä¹ˆå‡ ä¸ªï¼Œé¦–å…ˆæ˜¯ transformers, accelerate, torch å’Œ peft\nä»Šå¤©è¿™ä¸ª LoRA ä¸»è¦å°±æ˜¯ç”¨çš„ peft package.\nè‡³äº accelerate, å°±æ˜¯ç”¨æ¥åŠ é€Ÿ peft çš„\nStep2: æ•°æ®é›†åŠ è½½ # æ¥ä¸‹æ¥åŠ è½½æ•°æ®é›† # è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ datasets åº“æ¥åŠ è½½ Food101 æ•°æ®é›† from datasets import load_dataset # dataset = load_dataset(\"food101\", split=\"train[:5000]\") # åªåŠ è½½å‰5000ä¸ªæ ·æœ¬ä»¥åŠ å¿«é€Ÿåº¦ dataset = load_dataset(\"food101\", split=\"train+validation\") # åŠ è½½æ•´ä¸ªæ•°æ®é›† from datasets import Image as DatasetsImage dataset = dataset.cast_column(\"image\", DatasetsImage(decode=False)) # ç„¶åæŠŠæ ‡ç­¾æ‹¿å‡ºæ¥ # è¿™é‡Œ huggingface è¦æ±‚ä¸€ä¸ª labeltoid \u0026 idtolabel # æ‰€ä»¥è¿™é‡Œè¦å¼„ä¸¤ä¸ª map äº’ç›¸ map labels = dataset.features[\"label\"].names label2id, id2label = dict(), dict() for i, label in enumerate(labels): label2id[label] = i id2label[i] = label è¿™é‡Œdemoä¸­ç”¨çš„æ˜¯Food101æ•°æ®é›† (è€æ¼”å‘˜äº†[doge]),\nä½†æ˜¯è¿™ä¸ªä½œä¸º classification çš„æ•°æ®é›†å…¶å®ä¸å¤ªå¥½ï¼ˆå› ä¸ºé£Ÿç‰©çš„ç§ç±»éå¸¸éå¸¸å¤š\nä½†æ˜¯ä½œä¸ºLoRAåˆšåˆšå¥½ï¼Œå› ä¸ºLoRAå°±æ˜¯ä¸“é—¨é’ˆå¯¹è¿™ä¸ªäº‹æƒ…çš„\nåŠ è½½è¿™ä¸ªéƒ¨åˆ†å€’æ˜¯æ²¡ä»€ä¹ˆå¥½è¯´çš„\næœ€åè¿™ä¸ª .cast_column æ˜¯åæ¥å‘ç°è¿™ä¸ªæ•°æ®é›†å­˜çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸èƒ½ decode (by ChatGPT)\nStep3: åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ è¿™ä¸ªå¾ˆé‡è¦ï¼ï¼, ä¸è¦åˆ°æ—¶å€™è·‘èµ·æ¥äº†å‘ç°æ²¡æœ‰å¯¼å…¥é¢„è®­ç»ƒæ¨¡å‹\næ³¨ï¼šå¦‚æœæ²¡æœ‰åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¸ä¼šæœ‰ä»»ä½• Warning or Errorï¼Œä»€ä¹ˆéƒ½å¯ä»¥æ­£å¸¸è·‘ï¼Œä½†æ˜¯è·‘åˆ°æœ€åæ‰ä¼šå‘ç°å‡ºé—®é¢˜\n# æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹å’Œå›¾åƒå¤„ç†å™¨ # è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ transformers åº“æ¥åŠ è½½ä¸€ä¸ª ViT æ¨¡å‹ # ä»¥åŠä¸€ä¸ªå›¾åƒå¤„ç†å™¨ï¼ˆimage processorï¼‰æ¥å¤„ç†è¾“å…¥çš„å›¾åƒ from transformers import AutoImageProcessor model_checkpoint = \"google/vit-base-patch16-224-in21k\" image_processor = AutoImageProcessor.from_pretrained(model_checkpoint, use_fast=True) # æ¥ä¸‹æ¥æˆ‘ä»¬åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹ # è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ transformers åº“æ¥åŠ è½½ä¸€ä¸ª ViT æ¨¡å‹ from transformers import AutoModelForImageClassification, TrainingArguments, Trainer model = AutoModelForImageClassification.from_pretrained( model_checkpoint, label2id=label2id, id2label=id2label, ignore_mismatched_sizes=True, # provide this in case you're planning to fine-tune an already fine-tuned checkpoint ) è¿™é‡Œ tutorial ä¸­è¾“å…¥çš„æ˜¯ google çš„ VIT æ¨¡å‹\nå”¯ä¸€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ use_fast=True,\nåŠ ä¸Šä¹‹åæ®è¯´å›¾ç‰‡çš„å¯¼å…¥èƒ½å¿«10x to 30x\nStep4: åŠ è½½ Dataset # å¯¼å…¥ä¸€äº›å¸¸ç”¨çš„å›¾åƒå¤„ç†å‡½æ•° from torchvision.transforms import ( CenterCrop, Compose, Normalize, RandomHorizontalFlip, RandomResizedCrop, Resize, ToTensor, ) # æ¥ä¸‹æ¥æˆ‘ä»¬åšä¸€äº›é¢„å¤„ç† # é¦–å…ˆæ˜¯normalize normalize = Normalize(mean=image_processor.image_mean, std=image_processor.image_std) # ç„¶åæ˜¯trainå’Œvalidationçš„å›¾åƒå˜æ¢ train_transforms = Compose( [ RandomResizedCrop(image_processor.size[\"height\"]), RandomHorizontalFlip(), ToTensor(), normalize, ] ) # validationä¹Ÿæ˜¯ä¸€æ ·çš„å¤„ç† val_transforms = Compose( [ Resize(image_processor.size[\"height\"]), CenterCrop(image_processor.size[\"height\"]), ToTensor(), normalize, ] ) # ç„¶åå†™ä¸€ä¸ªå‡½æ•° process dataset def preprocess_train(example_batch): \"\"\"Apply train_transforms across a batch.\"\"\" example_batch[\"pixel_values\"] = [ train_transforms(Image.open(io.BytesIO(image[\"bytes\"])).convert(\"RGB\")) for image in example_batch[\"image\"] ] return example_batch # validationä¹Ÿæ˜¯ä¸€æ ·çš„å¤„ç† def preprocess_val(example_batch): \"\"\"Apply val_transforms across a batch.\"\"\" example_batch[\"pixel_values\"] = [ val_transforms(Image.open(io.BytesIO(image[\"bytes\"])).convert(\"RGB\")) for image in example_batch[\"image\"] ] return example_batch # æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹æ•°æ®é›†è¿›è¡Œé¢„å¤„ç†, æ‹†åˆ†æˆè®­ç»ƒé›†å’ŒéªŒè¯é›† splits = dataset.train_test_split(test_size=0.1) train_ds = splits[\"train\"] val_ds = splits[\"test\"] train_ds = train_ds.cast_column(\"image\", DatasetsImage(decode=False)) val_ds = val_ds.cast_column(\"image\", DatasetsImage(decode=False)) # ç„¶åtransformä¸€ä¸‹ train_ds.set_transform(preprocess_train) val_ds.set_transform(preprocess_val) è¿™é‡Œå’Œå…¶ä»–çš„æ¨¡å‹ä¹Ÿæ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯ä¸€æ ·çš„å¤„ç†æ–¹å¼\nè™½ç„¶è¿™é‡Œçœ‹èµ·æ¥å¾ˆé•¿ï¼Œä½†æ˜¯å…¶å®éƒ½æ˜¯ åˆ°å¤„copy-paste ğŸ¤¦â€â™‚ï¸\nStep 5: è®­ç»ƒå‰å‡†å¤‡ # è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ‰“å°æ¨¡å‹çš„å¯è®­ç»ƒå‚æ•°å’Œæ€»å‚æ•°æ•°é‡ # è¿™ä¸ªå‡½æ•°æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œåœ¨è¿™é‡Œæ ‡è®°ä¸€ä¸‹ def print_trainable_parameters(model): trainable_params = 0 all_param = 0 for _, param in model.named_parameters(): all_param += param.numel() if param.requires_grad: trainable_params += param.numel() print( f\"trainable params: {trainable_params} || all params: {all_param} || trainable%: {100 * trainable_params / all_param:.2f}\" ) # åŠ è½½config from transformers import TrainingArguments, Trainer model_name = model_checkpoint.split(\"/\")[-1] batch_size = 128 args = TrainingArguments( f\"{model_name}-finetuned-lora-food101\", remove_unused_columns=False, eval_strategy=\"epoch\", # æ³¨ï¼šè¿™é‡Œåœ¨ transformers 4.46+ ç‰ˆæœ¬åä» evluation_strategy æ”¹ä¸º eval_strategy save_strategy=\"epoch\", learning_rate=5e-3, per_device_train_batch_size=batch_size, gradient_accumulation_steps=4, per_device_eval_batch_size=batch_size, fp16=True, num_train_epochs=5, logging_steps=10, load_best_model_at_end=True, metric_for_best_model=\"accuracy\", push_to_hub=True, label_names=[\"labels\"], ) # æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®LoRAè®­ç»ƒå‚æ•° from peft import LoraConfig, get_peft_model config = LoraConfig( r=16, lora_alpha=16, target_modules=[\"query\", \"value\"], # è¿™é‡Œçš„ target_modules æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº›æ¨¡å—è¿›è¡Œ LoRA å¾®è°ƒ # ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç”šè‡³ä¸æ˜¯å¯¹æ•´ä¸ªæ¨¡å‹çš„çŸ©é˜µè¿›è¡Œåˆ†è§£ # è€Œæ˜¯å¯¹æ¨¡å‹ä¸­çš„æŸäº›ç‰¹å®šæ¨¡å—è¿›è¡Œåˆ†è§£ # è¿™é‡Œæˆ‘ä»¬é€‰æ‹©äº† query å’Œ value æ¨¡å— lora_dropout=0.1, bias=\"none\", modules_to_save=[\"classifier\"], # è¿™é‡Œçš„ modules_to_save æ˜¯æŒ‡æˆ‘ä»¬è¦ä¿å­˜å“ªäº›æ¨¡å—çš„å‚æ•° # ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªä¿å­˜åˆ†ç±»å™¨çš„å‚æ•° # è¿™æ ·çš„è¯ï¼Œéœ€è¦è®­ç»ƒçš„å‚æ•°å°±ä¼šè¿›ä¸€æ­¥å‡å°‘ ) import numpy as np import evaluate metric = evaluate.load(\"accuracy\") # å®šä¹‰è®¡ç®—æŒ‡æ ‡çš„å‡½æ•° def compute_metrics(eval_pred): \"\"\"Computes accuracy on a batch of predictions\"\"\" predictions = np.argmax(eval_pred.predictions, axis=1) return metric.compute(predictions=predictions, references=eval_pred.label_ids) # è¿™ä¸ªå‡½æ•°æ˜¯huggingface transformers ä¸­å’Œ pytorch dataloader __getitem__ æ–¹æ³•å¯¹åº”çš„å‡½æ•° # å®ƒçš„ä½œç”¨æ˜¯å°†æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ ·æœ¬è½¬æ¢ä¸ºæ¨¡å‹å¯ä»¥æ¥å—çš„æ ¼å¼ # è¿™é‡Œæˆ‘ä»¬å°†å›¾åƒè½¬æ¢ä¸º pixel_valuesï¼Œå¹¶å°†æ ‡ç­¾è½¬æ¢ä¸º label def collate_fn(examples): pixel_values = torch.stack([example[\"pixel_values\"] for example in examples]) labels = torch.tensor([example[\"label\"] for example in examples]) return {\"pixel_values\": pixel_values, \"labels\": labels} è®­ç»ƒå‰å‡†å¤‡åŒ…æ‹¬æ‰“å°å‚æ•°çš„è¾…åŠ©å‡½æ•°ï¼Œä»¥åŠæ‰€æœ‰çš„ hyper_parameters\nè¿˜æœ‰ evaluation matrix å’Œ collate_fn å‡½æ•°\nåœ¨è¿™é‡Œï¼Œè¿™äº›éƒ½æ˜¯å¦å¤–å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åƒ pytorch é‚£æ ·ï¼Œå®šä¹‰åœ¨ class é‡Œçš„\nStep 6: å®šä¹‰æ¨¡å‹ from transformers import AutoModelForImageClassification, TrainingArguments, Trainer # é¦–å…ˆå®šä¹‰åŸæœ¬çš„pretrain model model = AutoModelForImageClassification.from_pretrained( model_checkpoint, label2id=label2id, id2label=id2label, ignore_mismatched_sizes=True, # provide this in case you're planning to fine-tune an already fine-tuned checkpoint ) # æ‰“å°æ¨¡å‹çš„å¯è®­ç»ƒå‚æ•°å’Œæ€»å‚æ•°æ•°é‡ print_trainable_parameters(model) lora_model = get_peft_model(model, config) print_trainable_parameters(lora_model) è¿™ä¸€æ­¥å°±æ˜¯æŠŠå‰é¢çš„configå¯¼å…¥ä¸€ä¸‹ï¼Œ\nTransformer is all you need\nTransformeråº“ä¸­çš„ AutoModel ä¼šå¸®ä½ å®Œæˆä¸€åˆ‡çš„\nStep 7: æ¨¡å‹è®­ç»ƒ # ok, ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Trainer å¯¹è±¡ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è®­ç»ƒäº† trainer = Trainer( lora_model, args, train_dataset=train_ds, eval_dataset=val_ds, tokenizer=image_processor, compute_metrics=compute_metrics, data_collator=collate_fn, ) # ä½†æ˜¯å…ˆä¸ç€æ€¥ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¤§æ¨¡å‹ zero-shot çš„æ•ˆæœå¦‚ä½• print(\"Evaluating the base model without LoRA...\") zero_shot_results = trainer.evaluate(val_ds) print(f\"Zero-shot accuracy: \", zero_shot_results) with open(\"results.txt\", \"w\") as f: f.write(f\"Zero-shot accuracy: {zero_shot_results}\") print(\"Training the model with LoRA...\") train_results = trainer.train() print(\"Evaluating the LoRA model...\") LoRA_results = trainer.evaluate(val_ds) print(f\"LoRA accuracy: \", LoRA_results) with open(\"results.txt\", \"a\") as f: f.write(f\"LoRA accuracy: {LoRA_results}\") æœ€åå°±æ˜¯è®­ç»ƒçš„éƒ¨åˆ†äº†\næˆ‘ä»¬åªéœ€æŠŠ model, datasets, criteria_matrix å’Œ tokenizer è¾“å…¥è¿›å»å°± ok äº†\nå‰©ä¸‹çš„ .fit() å’Œ .evaluate() ä¼šå¸®æˆ‘ä»¬å®Œæˆ\næœ€åæˆ‘ä»¬å°±å¯ä»¥è¾“å‡ºç»“æœå•¦â™ª\nStep 8: Results origianl model trainable params: 85876325 || all params: 85876325 || trainable%: 100.00 LoRA trainable params: 667493 || all params: 86543818 || trainable%: 0.77 å¯ä»¥çœ‹åˆ°è¿™é‡Œ LoRA åªä¼šè®­ç»ƒ 0.77% çš„å‚æ•°\nZero-shot accuracy: {'eval_loss': 4.615139007568359, 'eval_model_preparation_time': 0.0094, 'eval_accuracy': 0.01287128712871287, 'eval_runtime': 68.1035, 'eval_samples_per_second': 148.304, 'eval_steps_per_second': 1.16} LoRA accuracy: {'eval_loss': 0.4589368402957916, 'eval_model_preparation_time': 0.0094, 'eval_accuracy': 0.8781188118811881, 'eval_runtime': 60.1694, 'eval_samples_per_second': 167.859, 'eval_steps_per_second': 1.313, 'epoch': 5.0} ä½†æ˜¯ LoRA çš„æ•ˆæœè¿˜æ˜¯æŒºå¥½çš„ï¼Œå‡†ç¡®ç‡ä» 1.3% -\u003e 87.8%, æå‡è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„\næˆ‘è¿™é‡Œä¸€å…±è®­ç»ƒäº†ä¸€ä¸ªå°æ—¶å·¦å³ã€‚\npytorch lightning ç‰ˆæœ¬ ç„¶åï¼Œæˆ‘çœ‹ openpi_pytorch åœ¨ç”¨ pytorch lightning, è¯´æ˜¯æ‡’äººæœ€çˆ±çš„ AI package, æˆ‘å°±æƒ³è¯•è¯•\nçœæµ æ€»ç»“ï¼Œpytorch lightning trainer çˆ†æ€äº† huggingface trainer\né‚£ä¹ˆï¼Œä»£ä»·æ˜¯ä»€ä¹ˆå‘¢\nä½ éœ€è¦å¤šå†™ä¸€ä¸ª module class å’Œ dataset class\nç”šè‡³ 20 è¡Œå°±èƒ½æå®š\nStep 9: pytorch lightning dataset class é¦–å…ˆï¼Œåœ¨åˆšæ‰çš„ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª dataset:\n# è¿™é‡Œå®šä¹‰ä¸€ä¸‹ Dataset class Food101DataModule(pl.LightningDataModule): def __init__(self, train_ds, val_ds, collate_fn, batch_size): super().__init__() self.train_ds = train_ds self.val_ds = val_ds # collate_fn ç›¸å½“äº__get_item__ self.collate_fn = collate_fn self.batch_size = batch_size def train_dataloader(self): return DataLoader(self.train_ds, batch_size=self.batch_size, shuffle=True, collate_fn=self.collate_fn, num_workers=64, pin_memory=True, prefetch_factor=4) def val_dataloader(self): return DataLoader(self.val_ds, batch_size=self.batch_size, shuffle=False, collate_fn=self.collate_fn, num_workers=64, pin_memory=True, prefetch_factor=4) data_module = Food101DataModule( train_ds=train_ds, val_ds=val_ds, collate_fn=collate_fn, batch_size=args.per_device_train_batch_size, ) å’Œä¹‹å‰ä¸€æ ·ï¼Œå¯¹å§â™ª\nåªä¸è¿‡ç°åœ¨è¦å¤šå†™ä¸€ä¸ª class è€Œå·²ï¼Œå…¶ä»–çš„éƒ½æ²¡æœ‰å˜å“¦â™ª\nStep 10: pytorch lightning model ç„¶åï¼Œæˆ‘ä»¬åªéœ€è¦å†å†™ä¸€ä¸ª pytorch lightning model å°±å¯ä»¥äº†\n# å®šä¹‰ä¸€ä¸‹ PyTorch Lightning æ¨¡å‹ # æ³¨ï¼šself.logçš„éƒ¨åˆ†æ˜¯ wandb çš„å†…å®¹ï¼Œç”¨äºå¯¼å‡ºlogçš„ class Food101Module(pl.LightningModule): def __init__(self, model, learning_rate, metric, collate_fn): super().__init__() self.model = model self.lr = learning_rate self.metric = metric self.collate_fn = collate_fn # PyTorch Lightning Module çš„ forward æ–¹æ³• def forward(self, pixel_values): # Huggingface çš„æ¨¡å‹è¾“å‡ºçš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å« logits å’Œå…¶ä»–ä¿¡æ¯ # è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ logits return self.model(pixel_values).logits def training_step(self, batch, batch_idx): pixel_values = batch[\"pixel_values\"] labels = batch[\"labels\"] logits = self(pixel_values) # è¿™ä¸€å¥è¯ç­‰ä»·äº logits=self.forward(pixel_values) loss = self.model.compute_loss(labels, logits) if hasattr(self.model, \"compute_loss\") else F.cross_entropy(logits, labels) # self.log(\"train_loss\", loss, on_step=True, on_epoch=True) return loss def validation_step(self, batch, batch_idx): pixel_values = batch[\"pixel_values\"] labels = batch[\"labels\"] logits = self(pixel_values) # also compute and log validation loss loss = F.cross_entropy(logits, labels) # self.log(\"val_loss\", loss, on_epoch=True) preds = torch.argmax(logits, dim=1) acc = self.metric.compute(predictions=preds, references=labels)[\"accuracy\"] # self.log(\"val_acc\", acc, on_epoch=True) def configure_optimizers(self): return torch.optim.AdamW(self.parameters(), lr=self.lr) lightning_module = Food101Module( model=lora_model, learning_rate=args.learning_rate, metric=metric, collate_fn=collate_fn, ) ä¹Ÿå’Œä¹‹å‰ä¸€æ ·ï¼Œä¸è¿‡æ˜¯è¦å®šä¹‰ä¸€ä¸‹ forward å’Œ optimizer è€Œå·²\næˆ‘è®¤ä¸ºå”¯ä¸€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼šhuggingface dataset ä¼šè¿”å›çš„ä¸æ­¢æ˜¯ logits, è¿˜æœ‰åˆ«çš„ä¿¡æ¯\næ‰€ä»¥ forward return çš„æ—¶å€™åªéœ€è¿”å› .logits å³å¯\nStep 11: train and validation pl_trainer.fit(lightning_module, datamodule=data_module) res = pl_trainer.validate(lightning_module, datamodule=data_module) æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ .fit å’Œ .validate\nStep 12: ç»“æœ å¯¹æ­¤ï¼Œæˆ‘åªèƒ½è¯´:\né¥é¥é¢†å…ˆ\nåªç”¨äº† 200 ç§’é’Ÿå°±å®Œæˆäº†1ä¸ª epoch + validation\nå·®ä¸å¤šæ˜¯hugging faceçš„4.5å€é€Ÿåº¦ã€‚\nåªä¸è¿‡å‘¢ï¼Œåƒ wandbè¿™äº›éƒ½è¦è‡ªå·±æ‰‹åŠ¨åŠ ï¼Œ\nè€Œ huggingface å°±ä¼šè‡ªå·± push åˆ°æ‰€æœ‰æ£€æµ‹åˆ°çš„ loggers\næ€»ç»“ æµ‹è¯•äº†ä¸€ä¸‹ pytorch lightning å’Œ huggingface çš„ LoRA æˆ‘å‘ç° pytorch lightning åœ¨ CPU IO ç“¶é¢ˆçš„æƒ…å†µä¸‹çš„è¡¨ç°æ˜¾è‘—æ¯” huggingface trainer è¦å¥½\n$$ \\text{huggingface train 1 epoch} \\approx 12 min $$\n$$ \\text{pytorch lightning train 1 epoch} \\approx 2 min $$\n$$ \\text{pytorch lightning validation} \\approx 8-10 s $$\n$$ \\text{huggingface validation} \\approx 60 s $$\næœ€å validation çš„ç»“æœéƒ½æ˜¯å·®ä¸å¤šçš„,ä½†æ˜¯ pytorch lightning å°±æ˜¯æ¯” huggingface tutorial è¦å¿«å¥½å‡ å€\n",
  "wordCount" : "1112",
  "inLanguage": "en",
  "datePublished": "2025-07-11T11:33:41+08:00",
  "dateModified": "2025-07-11T11:33:41+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://tzj2006.github.io/bugjournal/2025-07-11/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "TzJ's Net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://tzj2006.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://tzj2006.github.io/" accesskey="h" title="TzJ&#39;s Net (Alt + H)">TzJ&#39;s Net</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://tzj2006.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://tzj2006.github.io/bugjournal/" title="bugJournal">
                    <span>bugJournal</span>
                </a>
            </li>
            <li>
                <a href="https://tzj2006.github.io/leetcode/" title="leetcode">
                    <span>leetcode</span>
                </a>
            </li>
            <li>
                <a href="https://tzj2006.github.io/posts/" title="posts &amp; notes">
                    <span>posts &amp; notes</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://tzj2006.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://tzj2006.github.io/bugjournal/">BugJournals</a></div>
    <h1 class="post-title entry-hint-parent">
      Bug Journal 2025-07-11
    </h1>
    <div class="post-meta"><span title='2025-07-11 11:33:41 +0800 +0800'>July 11, 2025</span>&nbsp;Â·&nbsp;6 min


      
      <div class="meta-item">
        <span id="busuanzi_container_page_pv">
           &nbsp; People Read: <span id="busuanzi_value_page_pv"></span>
        </span>
     </div>

    </div>
  </header> 
  <div class="post-content"><h2 id="lora-finetuning">LoRA finetuning<a hidden class="anchor" aria-hidden="true" href="#lora-finetuning">#</a></h2>
<p>ä¹‹å‰ä¸€ç›´å¬è¯´ LoRA çš„å¤§åï¼Œä»Šå¤©æ¥çœ‹çœ‹ LoRA åˆ°åº•åœ¨åšä»€ä¹ˆ</p>
<p>æ­£å¥½æˆ‘çœ‹åˆ°äº† huggingface ä¸Šæœ‰ <a href="https://huggingface.co/docs/peft/main/en/developer_guides/lora">LoRA tutorial</a> æ‰€ä»¥å°±è¿‡æ¥ç ”ç©¶äº†ä¸€ä¸‹ğŸ§</p>
<p><em>æ³¨ï¼šä»£ç é¡ºåºä¸ tutorialä¸­ç•¥æœ‰å‡ºå…¥</em></p>
<p>çœæµï¼šæƒ³çœ‹ LoRA specific çš„åŒå­¦è¯·ç›´æ¥ä»[è¿™é‡Œå¼€å§‹çœ‹](#Step 5: è®­ç»ƒå‰å‡†å¤‡)</p>
<h4 id="step1-å¯¼å…¥éœ€è¦ç”¨åˆ°çš„-package">Step1: å¯¼å…¥éœ€è¦ç”¨åˆ°çš„ package<a hidden class="anchor" aria-hidden="true" href="#step1-å¯¼å…¥éœ€è¦ç”¨åˆ°çš„-package">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">transformers</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">accelerate</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">peft</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;transformers version: </span><span class="si">{</span><span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;accelerate version: </span><span class="si">{</span><span class="n">accelerate</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;torch version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;peft version: </span><span class="si">{</span><span class="n">peft</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>éœ€è¦å¯¼å…¥çš„ package å¤§æ¦‚å°±è¿™ä¹ˆå‡ ä¸ªï¼Œé¦–å…ˆæ˜¯ transformers, accelerate, torch å’Œ peft</p>
<p>ä»Šå¤©è¿™ä¸ª LoRA ä¸»è¦å°±æ˜¯ç”¨çš„ peft package.</p>
<p>è‡³äº accelerate, å°±æ˜¯ç”¨æ¥åŠ é€Ÿ peft çš„</p>
<h4 id="step2-æ•°æ®é›†åŠ è½½">Step2: æ•°æ®é›†åŠ è½½<a hidden class="anchor" aria-hidden="true" href="#step2-æ•°æ®é›†åŠ è½½">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥åŠ è½½æ•°æ®é›†</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ datasets åº“æ¥åŠ è½½ Food101 æ•°æ®é›†</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dataset = load_dataset(&#34;food101&#34;, split=&#34;train[:5000]&#34;)  # åªåŠ è½½å‰5000ä¸ªæ ·æœ¬ä»¥åŠ å¿«é€Ÿåº¦</span>
</span></span><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&#34;food101&#34;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&#34;train+validation&#34;</span><span class="p">)</span>  <span class="c1"># åŠ è½½æ•´ä¸ªæ•°æ®é›†</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">DatasetsImage</span>
</span></span><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="n">DatasetsImage</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç„¶åæŠŠæ ‡ç­¾æ‹¿å‡ºæ¥</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œ huggingface è¦æ±‚ä¸€ä¸ª labeltoid &amp; idtolabel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ‰€ä»¥è¿™é‡Œè¦å¼„ä¸¤ä¸ª map äº’ç›¸ map</span>
</span></span><span class="line"><span class="cl"><span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&#34;label&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">names</span>
</span></span><span class="line"><span class="cl"><span class="n">label2id</span><span class="p">,</span> <span class="n">id2label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">label2id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">    <span class="n">id2label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
</span></span></code></pre></div><p>è¿™é‡Œdemoä¸­ç”¨çš„æ˜¯Food101æ•°æ®é›† (è€æ¼”å‘˜äº†[doge]),</p>
<p>ä½†æ˜¯è¿™ä¸ªä½œä¸º classification çš„æ•°æ®é›†å…¶å®ä¸å¤ªå¥½ï¼ˆå› ä¸ºé£Ÿç‰©çš„ç§ç±»éå¸¸éå¸¸å¤š</p>
<p>ä½†æ˜¯ä½œä¸ºLoRAåˆšåˆšå¥½ï¼Œå› ä¸ºLoRAå°±æ˜¯ä¸“é—¨é’ˆå¯¹è¿™ä¸ªäº‹æƒ…çš„</p>
<p>åŠ è½½è¿™ä¸ªéƒ¨åˆ†å€’æ˜¯æ²¡ä»€ä¹ˆå¥½è¯´çš„</p>
<p>æœ€åè¿™ä¸ª .cast_column æ˜¯åæ¥å‘ç°è¿™ä¸ªæ•°æ®é›†å­˜çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸èƒ½ decode (by ChatGPT)</p>
<h4 id="step3-åŠ è½½é¢„è®­ç»ƒæ¨¡å‹">Step3: åŠ è½½é¢„è®­ç»ƒæ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#step3-åŠ è½½é¢„è®­ç»ƒæ¨¡å‹">#</a></h4>
<p><strong>è¿™ä¸ªå¾ˆé‡è¦ï¼ï¼</strong>, ä¸è¦åˆ°æ—¶å€™è·‘èµ·æ¥äº†å‘ç°æ²¡æœ‰å¯¼å…¥é¢„è®­ç»ƒæ¨¡å‹</p>
<p><em>æ³¨ï¼šå¦‚æœæ²¡æœ‰åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¸ä¼šæœ‰<strong>ä»»ä½• Warning or Error</strong>ï¼Œä»€ä¹ˆéƒ½å¯ä»¥æ­£å¸¸è·‘ï¼Œä½†æ˜¯è·‘åˆ°æœ€åæ‰ä¼šå‘ç°å‡ºé—®é¢˜</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹å’Œå›¾åƒå¤„ç†å™¨</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ transformers åº“æ¥åŠ è½½ä¸€ä¸ª ViT æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä»¥åŠä¸€ä¸ªå›¾åƒå¤„ç†å™¨ï¼ˆimage processorï¼‰æ¥å¤„ç†è¾“å…¥çš„å›¾åƒ</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoImageProcessor</span>
</span></span><span class="line"><span class="cl"><span class="n">model_checkpoint</span> <span class="o">=</span> <span class="s2">&#34;google/vit-base-patch16-224-in21k&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">image_processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥æˆ‘ä»¬åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Hugging Face çš„ transformers åº“æ¥åŠ è½½ä¸€ä¸ª ViT æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForImageClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForImageClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">id2label</span><span class="o">=</span><span class="n">id2label</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ignore_mismatched_sizes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># provide this in case you&#39;re planning to fine-tune an already fine-tuned checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>è¿™é‡Œ tutorial ä¸­è¾“å…¥çš„æ˜¯ google çš„ VIT æ¨¡å‹</p>
<p>å”¯ä¸€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>use_fast=True</code>,</p>
<p>åŠ ä¸Šä¹‹åæ®è¯´å›¾ç‰‡çš„å¯¼å…¥èƒ½å¿«<code>10x to 30x</code></p>
<h4 id="step4-åŠ è½½-dataset">Step4: åŠ è½½ Dataset<a hidden class="anchor" aria-hidden="true" href="#step4-åŠ è½½-dataset">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># å¯¼å…¥ä¸€äº›å¸¸ç”¨çš„å›¾åƒå¤„ç†å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">CenterCrop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Compose</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Normalize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RandomHorizontalFlip</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RandomResizedCrop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Resize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ToTensor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥æˆ‘ä»¬åšä¸€äº›é¢„å¤„ç†</span>
</span></span><span class="line"><span class="cl"><span class="c1"># é¦–å…ˆæ˜¯normalize</span>
</span></span><span class="line"><span class="cl"><span class="n">normalize</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">image_processor</span><span class="o">.</span><span class="n">image_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">image_processor</span><span class="o">.</span><span class="n">image_std</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç„¶åæ˜¯trainå’Œvalidationçš„å›¾åƒå˜æ¢</span>
</span></span><span class="line"><span class="cl"><span class="n">train_transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">RandomResizedCrop</span><span class="p">(</span><span class="n">image_processor</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="s2">&#34;height&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">ToTensor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># validationä¹Ÿæ˜¯ä¸€æ ·çš„å¤„ç†</span>
</span></span><span class="line"><span class="cl"><span class="n">val_transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Resize</span><span class="p">(</span><span class="n">image_processor</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="s2">&#34;height&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">CenterCrop</span><span class="p">(</span><span class="n">image_processor</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="s2">&#34;height&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">ToTensor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">normalize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç„¶åå†™ä¸€ä¸ªå‡½æ•° process dataset</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">preprocess_train</span><span class="p">(</span><span class="n">example_batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Apply train_transforms across a batch.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">example_batch</span><span class="p">[</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">train_transforms</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s2">&#34;bytes&#34;</span><span class="p">]))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&#34;RGB&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">example_batch</span><span class="p">[</span><span class="s2">&#34;image&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">example_batch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># validationä¹Ÿæ˜¯ä¸€æ ·çš„å¤„ç†</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">preprocess_val</span><span class="p">(</span><span class="n">example_batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Apply val_transforms across a batch.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">example_batch</span><span class="p">[</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_transforms</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s2">&#34;bytes&#34;</span><span class="p">]))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&#34;RGB&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">example_batch</span><span class="p">[</span><span class="s2">&#34;image&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">example_batch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹æ•°æ®é›†è¿›è¡Œé¢„å¤„ç†, æ‹†åˆ†æˆè®­ç»ƒé›†å’ŒéªŒè¯é›†</span>
</span></span><span class="line"><span class="cl"><span class="n">splits</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">train_ds</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="s2">&#34;train&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">val_ds</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="s2">&#34;test&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="n">DatasetsImage</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">val_ds</span> <span class="o">=</span> <span class="n">val_ds</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="n">DatasetsImage</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç„¶åtransformä¸€ä¸‹</span>
</span></span><span class="line"><span class="cl"><span class="n">train_ds</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">preprocess_train</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">val_ds</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">preprocess_val</span><span class="p">)</span>
</span></span></code></pre></div><p>è¿™é‡Œå’Œå…¶ä»–çš„æ¨¡å‹ä¹Ÿæ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯ä¸€æ ·çš„å¤„ç†æ–¹å¼</p>
<p>è™½ç„¶è¿™é‡Œçœ‹èµ·æ¥å¾ˆé•¿ï¼Œä½†æ˜¯å…¶å®éƒ½æ˜¯ åˆ°å¤„copy-paste ğŸ¤¦â€â™‚ï¸</p>
<h4 id="step-5-è®­ç»ƒå‰å‡†å¤‡">Step 5: è®­ç»ƒå‰å‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#step-5-è®­ç»ƒå‰å‡†å¤‡">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ‰“å°æ¨¡å‹çš„å¯è®­ç»ƒå‚æ•°å’Œæ€»å‚æ•°æ•°é‡</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™ä¸ªå‡½æ•°æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œåœ¨è¿™é‡Œæ ‡è®°ä¸€ä¸‹</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_trainable_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">trainable_params</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_param</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">all_param</span> <span class="o">+=</span> <span class="n">param</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">trainable_params</span> <span class="o">+=</span> <span class="n">param</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;trainable params: </span><span class="si">{</span><span class="n">trainable_params</span><span class="si">}</span><span class="s2"> || all params: </span><span class="si">{</span><span class="n">all_param</span><span class="si">}</span><span class="s2"> || trainable%: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">trainable_params</span> <span class="o">/</span> <span class="n">all_param</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1"># åŠ è½½config</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
</span></span><span class="line"><span class="cl"><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_checkpoint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">-finetuned-lora-food101&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">remove_unused_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">eval_strategy</span><span class="o">=</span><span class="s2">&#34;epoch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ³¨ï¼šè¿™é‡Œåœ¨ transformers 4.46+ ç‰ˆæœ¬åä» evluation_strategy æ”¹ä¸º eval_strategy</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&#34;epoch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&#34;accuracy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">label_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;labels&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®LoRAè®­ç»ƒå‚æ•°</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">peft</span> <span class="kn">import</span> <span class="n">LoraConfig</span><span class="p">,</span> <span class="n">get_peft_model</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">lora_alpha</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™é‡Œçš„ target_modules æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº›æ¨¡å—è¿›è¡Œ LoRA å¾®è°ƒ</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç”šè‡³ä¸æ˜¯å¯¹æ•´ä¸ªæ¨¡å‹çš„çŸ©é˜µè¿›è¡Œåˆ†è§£</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è€Œæ˜¯å¯¹æ¨¡å‹ä¸­çš„æŸäº›ç‰¹å®šæ¨¡å—è¿›è¡Œåˆ†è§£</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™é‡Œæˆ‘ä»¬é€‰æ‹©äº† query å’Œ value æ¨¡å—</span>
</span></span><span class="line"><span class="cl">    <span class="n">lora_dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">bias</span><span class="o">=</span><span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">modules_to_save</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;classifier&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™é‡Œçš„ modules_to_save æ˜¯æŒ‡æˆ‘ä»¬è¦ä¿å­˜å“ªäº›æ¨¡å—çš„å‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªä¿å­˜åˆ†ç±»å™¨çš„å‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™æ ·çš„è¯ï¼Œéœ€è¦è®­ç»ƒçš„å‚æ•°å°±ä¼šè¿›ä¸€æ­¥å‡å°‘</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">evaluate</span>
</span></span><span class="line"><span class="cl"><span class="n">metric</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;accuracy&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å®šä¹‰è®¡ç®—æŒ‡æ ‡çš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Computes accuracy on a batch of predictions&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eval_pred</span><span class="o">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">eval_pred</span><span class="o">.</span><span class="n">label_ids</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™ä¸ªå‡½æ•°æ˜¯huggingface transformers ä¸­å’Œ pytorch dataloader __getitem__ æ–¹æ³•å¯¹åº”çš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å®ƒçš„ä½œç”¨æ˜¯å°†æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ ·æœ¬è½¬æ¢ä¸ºæ¨¡å‹å¯ä»¥æ¥å—çš„æ ¼å¼</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œæˆ‘ä»¬å°†å›¾åƒè½¬æ¢ä¸º pixel_valuesï¼Œå¹¶å°†æ ‡ç­¾è½¬æ¢ä¸º label</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s2">&#34;label&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">:</span> <span class="n">pixel_values</span><span class="p">,</span> <span class="s2">&#34;labels&#34;</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>
</span></span></code></pre></div><p>è®­ç»ƒå‰å‡†å¤‡åŒ…æ‹¬æ‰“å°å‚æ•°çš„è¾…åŠ©å‡½æ•°ï¼Œä»¥åŠæ‰€æœ‰çš„ hyper_parameters</p>
<p>è¿˜æœ‰ evaluation matrix å’Œ collate_fn å‡½æ•°</p>
<p>åœ¨è¿™é‡Œï¼Œè¿™äº›éƒ½æ˜¯å¦å¤–å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åƒ pytorch é‚£æ ·ï¼Œå®šä¹‰åœ¨ class é‡Œçš„</p>
<h4 id="step-6-å®šä¹‰æ¨¡å‹">Step 6: å®šä¹‰æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#step-6-å®šä¹‰æ¨¡å‹">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForImageClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># é¦–å…ˆå®šä¹‰åŸæœ¬çš„pretrain model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForImageClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">id2label</span><span class="o">=</span><span class="n">id2label</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ignore_mismatched_sizes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># provide this in case you&#39;re planning to fine-tune an already fine-tuned checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ‰“å°æ¨¡å‹çš„å¯è®­ç»ƒå‚æ•°å’Œæ€»å‚æ•°æ•°é‡</span>
</span></span><span class="line"><span class="cl"><span class="n">print_trainable_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lora_model</span> <span class="o">=</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">print_trainable_parameters</span><span class="p">(</span><span class="n">lora_model</span><span class="p">)</span>
</span></span></code></pre></div><p>è¿™ä¸€æ­¥å°±æ˜¯æŠŠå‰é¢çš„configå¯¼å…¥ä¸€ä¸‹ï¼Œ</p>
<p><del>Transformer is all you need</del></p>
<p>Transformeråº“ä¸­çš„ AutoModel ä¼šå¸®ä½ å®Œæˆä¸€åˆ‡çš„</p>
<h4 id="step-7-æ¨¡å‹è®­ç»ƒ">Step 7: æ¨¡å‹è®­ç»ƒ<a hidden class="anchor" aria-hidden="true" href="#step-7-æ¨¡å‹è®­ç»ƒ">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ok, ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Trainer å¯¹è±¡ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è®­ç»ƒäº†</span>
</span></span><span class="line"><span class="cl"><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">lora_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenizer</span><span class="o">=</span><span class="n">image_processor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_collator</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä½†æ˜¯å…ˆä¸ç€æ€¥ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¤§æ¨¡å‹ zero-shot çš„æ•ˆæœå¦‚ä½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Evaluating the base model without LoRA...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">zero_shot_results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_ds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Zero-shot accuracy: &#34;</span><span class="p">,</span> <span class="n">zero_shot_results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;results.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Zero-shot accuracy: </span><span class="si">{</span><span class="n">zero_shot_results</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Training the model with LoRA...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">train_results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Evaluating the LoRA model...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">LoRA_results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_ds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;LoRA accuracy: &#34;</span><span class="p">,</span> <span class="n">LoRA_results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;results.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;LoRA accuracy: </span><span class="si">{</span><span class="n">LoRA_results</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>æœ€åå°±æ˜¯è®­ç»ƒçš„éƒ¨åˆ†äº†</p>
<p>æˆ‘ä»¬åªéœ€æŠŠ model, datasets, criteria_matrix å’Œ tokenizer è¾“å…¥è¿›å»å°± ok äº†</p>
<p>å‰©ä¸‹çš„ <code>.fit()</code> å’Œ <code>.evaluate()</code> ä¼šå¸®æˆ‘ä»¬å®Œæˆ</p>
<p>æœ€åæˆ‘ä»¬å°±å¯ä»¥è¾“å‡ºç»“æœå•¦â™ª</p>
<h4 id="step-8-results">Step 8: Results<a hidden class="anchor" aria-hidden="true" href="#step-8-results">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">origianl model trainable params: 85876325 || all params: 85876325 || trainable%: 100.00
</span></span><span class="line"><span class="cl">LoRA trainable params: 667493 || all params: 86543818 || trainable%: 0.77
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œ LoRA åªä¼šè®­ç»ƒ 0.77% çš„å‚æ•°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Zero-shot accuracy</span><span class="p">:</span><span class="w"> </span>{<span class="nt">&#39;eval_loss&#39;: 4.615139007568359, &#39;eval_model_preparation_time&#39;: 0.0094, &#39;eval_accuracy&#39;: 0.01287128712871287, &#39;eval_runtime&#39;: 68.1035, &#39;eval_samples_per_second&#39;: 148.304, &#39;eval_steps_per_second&#39;</span><span class="p">:</span><span class="w"> </span><span class="m">1.16</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">LoRA accuracy</span><span class="p">:</span><span class="w"> </span>{<span class="nt">&#39;eval_loss&#39;: 0.4589368402957916, &#39;eval_model_preparation_time&#39;: 0.0094, &#39;eval_accuracy&#39;: 0.8781188118811881, &#39;eval_runtime&#39;: 60.1694, &#39;eval_samples_per_second&#39;: 167.859, &#39;eval_steps_per_second&#39;: 1.313, &#39;epoch&#39;</span><span class="p">:</span><span class="w"> </span><span class="m">5.0</span>}<span class="w">
</span></span></span></code></pre></div><p>ä½†æ˜¯ LoRA çš„æ•ˆæœè¿˜æ˜¯æŒºå¥½çš„ï¼Œå‡†ç¡®ç‡ä» 1.3% -&gt; 87.8%, æå‡è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„</p>
<p>æˆ‘è¿™é‡Œä¸€å…±è®­ç»ƒäº†ä¸€ä¸ªå°æ—¶å·¦å³ã€‚</p>
<p><img alt="image-20250711122527798" loading="lazy" src="https://tzj2006.github.io/images/2025-07-11/image-20250711122527798.png"></p>
<h3 id="pytorch-lightning-ç‰ˆæœ¬">pytorch lightning ç‰ˆæœ¬<a hidden class="anchor" aria-hidden="true" href="#pytorch-lightning-ç‰ˆæœ¬">#</a></h3>
<p>ç„¶åï¼Œæˆ‘çœ‹ <a href="https://github.com/ZibinDong/openpi_pytorch">openpi_pytorch</a> åœ¨ç”¨ pytorch lightning, è¯´æ˜¯æ‡’äººæœ€çˆ±çš„ AI package, æˆ‘å°±æƒ³è¯•è¯•</p>
<h4 id="çœæµ">çœæµ<a hidden class="anchor" aria-hidden="true" href="#çœæµ">#</a></h4>
<p>æ€»ç»“ï¼Œpytorch lightning trainer çˆ†æ€äº† huggingface trainer</p>
<hr>
<p><del>é‚£ä¹ˆï¼Œä»£ä»·æ˜¯ä»€ä¹ˆå‘¢</del></p>
<p>ä½ éœ€è¦å¤šå†™ä¸€ä¸ª module class å’Œ dataset class</p>
<p>ç”šè‡³ 20 è¡Œå°±èƒ½æå®š</p>
<h4 id="step-9-pytorch-lightning-dataset-class">Step 9: pytorch lightning dataset class<a hidden class="anchor" aria-hidden="true" href="#step-9-pytorch-lightning-dataset-class">#</a></h4>
<p>é¦–å…ˆï¼Œåœ¨åˆšæ‰çš„ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª dataset:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># è¿™é‡Œå®šä¹‰ä¸€ä¸‹ Dataset</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Food101DataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span> <span class="o">=</span> <span class="n">val_ds</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># collate_fn ç›¸å½“äº__get_item__</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate_fn</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">data_module</span> <span class="o">=</span> <span class="n">Food101DataModule</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_ds</span><span class="o">=</span><span class="n">train_ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">val_ds</span><span class="o">=</span><span class="n">val_ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">per_device_train_batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>å’Œä¹‹å‰ä¸€æ ·ï¼Œå¯¹å§â™ª</p>
<p>åªä¸è¿‡ç°åœ¨è¦å¤šå†™ä¸€ä¸ª class è€Œå·²ï¼Œå…¶ä»–çš„éƒ½æ²¡æœ‰å˜å“¦â™ª</p>
<h4 id="step-10-pytorch-lightning-model">Step 10: pytorch lightning model<a hidden class="anchor" aria-hidden="true" href="#step-10-pytorch-lightning-model">#</a></h4>
<p>ç„¶åï¼Œæˆ‘ä»¬åªéœ€è¦å†å†™ä¸€ä¸ª pytorch lightning model å°±å¯ä»¥äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># å®šä¹‰ä¸€ä¸‹ PyTorch Lightning æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ³¨ï¼šself.logçš„éƒ¨åˆ†æ˜¯ wandb çš„å†…å®¹ï¼Œç”¨äºå¯¼å‡ºlogçš„</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Food101Module</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate_fn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># PyTorch Lightning Module çš„ forward æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Huggingface çš„æ¨¡å‹è¾“å‡ºçš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å« logits å’Œå…¶ä»–ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ logits</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&#34;labels&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿™ä¸€å¥è¯ç­‰ä»·äº logits=self.forward(pixel_values)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&#34;compute_loss&#34;</span><span class="p">)</span> <span class="k">else</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.log(&#34;train_loss&#34;, loss, on_step=True, on_epoch=True)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">loss</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&#34;pixel_values&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&#34;labels&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># also compute and log validation loss</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.log(&#34;val_loss&#34;, loss, on_epoch=True)</span>
</span></span><span class="line"><span class="cl">        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)[</span><span class="s2">&#34;accuracy&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.log(&#34;val_acc&#34;, acc, on_epoch=True)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"><span class="n">lightning_module</span> <span class="o">=</span> <span class="n">Food101Module</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="n">lora_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>ä¹Ÿå’Œä¹‹å‰ä¸€æ ·ï¼Œä¸è¿‡æ˜¯è¦å®šä¹‰ä¸€ä¸‹ forward å’Œ optimizer è€Œå·²</p>
<p>æˆ‘è®¤ä¸ºå”¯ä¸€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼šhuggingface dataset ä¼šè¿”å›çš„ä¸æ­¢æ˜¯ logits, è¿˜æœ‰åˆ«çš„ä¿¡æ¯</p>
<p>æ‰€ä»¥ forward return çš„æ—¶å€™åªéœ€è¿”å› <code>.logits</code> å³å¯</p>
<h4 id="step-11-train-and-validation">Step 11: train and validation<a hidden class="anchor" aria-hidden="true" href="#step-11-train-and-validation">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pl_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lightning_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">data_module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">pl_trainer</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">lightning_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">data_module</span><span class="p">)</span>
</span></span></code></pre></div><p>æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ <code>.fit</code> å’Œ <code>.validate</code></p>
<h4 id="step-12-ç»“æœ">Step 12: ç»“æœ<a hidden class="anchor" aria-hidden="true" href="#step-12-ç»“æœ">#</a></h4>
<p><img alt="image-20250711142208300" loading="lazy" src="https://tzj2006.github.io/images/2025-07-11/image-20250711142208300.png"></p>
<p>å¯¹æ­¤ï¼Œæˆ‘åªèƒ½è¯´:</p>
<p><strong>é¥é¥é¢†å…ˆ</strong></p>
<p>åªç”¨äº† 200 ç§’é’Ÿå°±å®Œæˆäº†1ä¸ª epoch + validation</p>
<p>å·®ä¸å¤šæ˜¯hugging faceçš„4.5å€é€Ÿåº¦ã€‚</p>
<p>åªä¸è¿‡å‘¢ï¼Œåƒ wandbè¿™äº›éƒ½è¦è‡ªå·±æ‰‹åŠ¨åŠ ï¼Œ</p>
<p>è€Œ huggingface å°±ä¼šè‡ªå·± push åˆ°æ‰€æœ‰æ£€æµ‹åˆ°çš„ loggers</p>
<h3 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h3>
<p>æµ‹è¯•äº†ä¸€ä¸‹ pytorch lightning å’Œ huggingface çš„ LoRA
æˆ‘å‘ç° pytorch lightning åœ¨ CPU IO ç“¶é¢ˆçš„æƒ…å†µä¸‹çš„è¡¨ç°æ˜¾è‘—æ¯” huggingface trainer è¦å¥½</p>
<p>$$ \text{huggingface train 1 epoch} \approx 12 min $$</p>
<p>$$ \text{pytorch lightning train 1 epoch} \approx 2 min $$</p>
<p>$$ \text{pytorch lightning validation} \approx 8-10 s $$</p>
<p>$$ \text{huggingface validation} \approx 60 s $$</p>
<p>æœ€å validation çš„ç»“æœéƒ½æ˜¯å·®ä¸å¤šçš„,ä½†æ˜¯ pytorch lightning å°±æ˜¯æ¯” huggingface tutorial è¦å¿«å¥½å‡ å€</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://tzj2006.github.io/">TzJ&#39;s Net</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <span>
        Â· æœ¬ç«™è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>
        Â· æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
